@model MovieTickets.Models.Movie
@using System.Text.Encodings.Web

@{
    ViewData["Title"] = Model?.Title ?? "Movie details";

    // safe access to current HttpRequest (works in Views & Partials)
    var httpRequest = Context?.Request ?? ViewContext?.HttpContext?.Request;
    string absoluteUrl = "";

    if (httpRequest != null)
    {
        // use Url.Action overload that accepts protocol + host to generate absolute url
        var host = httpRequest.Host.HasValue ? httpRequest.Host.Value : "";
        absoluteUrl = Url.Action("Details", "Movies", new { id = Model?.Id }, httpRequest.Scheme, host) ?? "";
    }

    // poster / gallery logic (poster prioritized)
    var posterUrl = Url.Content(Model?.ImgUrl ?? Model?.MovieImgs?.FirstOrDefault()?.ImgUrl ?? "~/images/placeholder-movie.png");
    var gallery = (Model?.MovieImgs ?? Enumerable.Empty<MovieTickets.Models.MovieImg>())
                    .Where(mi => !string.IsNullOrWhiteSpace(mi?.ImgUrl))
                    .Select(mi => Url.Content(mi.ImgUrl))
                    .ToList();

    // ensure poster is first in gallery (avoid duplication)
    if (!string.IsNullOrWhiteSpace(Model?.ImgUrl))
    {
        gallery.RemoveAll(g => string.Equals(g, Url.Content(Model.ImgUrl), StringComparison.OrdinalIgnoreCase));
        gallery.Insert(0, Url.Content(Model.ImgUrl));
    }
    else if (gallery.Any())
    {
        // make sure posterUrl is the first element (and not duplicated)
        gallery.RemoveAll(g => string.Equals(g, posterUrl, StringComparison.OrdinalIgnoreCase));
        gallery.Insert(0, posterUrl);
    }
}


<link rel="stylesheet" href="~/css/movie-details.css" />

<div class="container py-4">
    <div class="row gx-4 gy-4">
        <!-- Left: Poster + carousel -->
        <div class="col-lg-7">
            <div class="card movie-card-modern shadow-lg overflow-hidden">
                <div class="position-relative poster-wrap">
                    <img id="mainPoster" src="@posterUrl" alt="Poster for @(HtmlEncoder.Default.Encode(Model?.Title))" class="img-fluid main-poster lazy" loading="lazy" />
                    <div class="poster-gradient"></div>

                    <div class="poster-actions d-flex gap-2">
                        <button id="playTrailerBtn" class="btn btn-lg btn-play" data-trailer="@Html.Raw(Html.Encode(Model?.TrailerUrl))" title="Play trailer" @(string.IsNullOrWhiteSpace(Model?.TrailerUrl) ? "disabled" : "")>
                            <i class="bi bi-play-fill"></i>
                        </button>

                        <a asp-action="Index" asp-controller="Movies" class="btn btn-outline-light btn-sm">← Back</a>
                    </div>

                    <div class="poster-meta">
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge rounded-pill bg-warning text-dark fw-bold">@((Model?.Price.ToString("0.##")) ?? "-") EGP</span>
                            <span class="text-white small">@((Model?.StartDate.ToString("yyyy-MM-dd")) ?? "-")</span>
                        </div>
                    </div>
                </div>

                <!-- Carousel (Bootstrap) -->
                <div id="galleryCarousel" class="carousel slide" data-bs-ride="false" data-bs-interval="false">
                    <div class="carousel-inner">
                        @if (gallery != null && gallery.Any())
                        {
                            for (int i = 0; i < gallery.Count; i++)
                            {
                                var g = gallery[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img data-src="@g" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" class="d-block w-100 gallery-img lazy" alt="Image @(i + 1) for @HtmlEncoder.Default.Encode(Model?.Title)" loading="lazy" />
                                </div>
                            }
                        }
                        else
                        {
                            <div class="carousel-item active">
                                <img src="~/images/placeholder-movie.png" class="d-block w-100 gallery-img" alt="No images" loading="lazy" />
                            </div>
                        }
                        }
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>

                <!-- Thumbnails -->
                <div class="thumbs-wrapper">
                    <div class="thumbs-scroll d-flex gap-2 py-2">
                        @for (int i = 0; i < (gallery?.Count ?? 0); i++)
                        {
                            var t = gallery[i];
                            <button class="thumb btn p-0" data-slide-index="@i" aria-label="Open image @(i + 1)">
                                <img data-src="@t" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" class="thumb-img lazy rounded" alt="Thumbnail @(i + 1)" loading="lazy" />
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Details -->
        <div class="col-lg-5">
            <div class="card shadow-sm p-4 details-card">
                <h1 class="h4 mb-1">@Model?.Title</h1>
                <p class="text-muted small mb-2">@((Model?.Cinema?.Name) ?? "—") &nbsp;•&nbsp; @((Model?.Category?.Name) ?? "—")</p>

                <div class="d-flex align-items-center gap-3 mb-3">
                    <!-- Rating placeholder -->
                    <div class="rating-stars" aria-hidden="true">
                        <span class="star active">★</span><span class="star active">★</span><span class="star active">★</span><span class="star">☆</span><span class="star">☆</span>
                    </div>
                    <div class="small text-muted">No reviews yet</div>
                </div>

                <div class="mb-3">
                    <h6 class="mb-1">About</h6>
                    <p class="text-muted mb-1">@Model?.Description</p>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <span class="badge bg-light text-dark border">Duration: @((Model?.StartDate.ToString("yyyy")) ?? "-")</span>
                        <span class="badge bg-light text-dark border">Dates: @Model?.StartDate.ToString("yyyy-MM-dd") @if(Model?.EndDate > Model?.StartDate) {
                        <span>— @Model?.EndDate.ToString("yyyy-MM-dd")</span>
                                                }
</span>
                        <span class="badge bg-light text-dark border">Price: @Model?.Price.ToString("0.##") EGP</span>
                    </div>
                </div>

                <div class="mb-3">
                    <h6 class="mb-1">Cast</h6>
                    <div>
                        @if (Model?.MovieActors != null && Model.MovieActors.Any())
                        {
                            foreach (var ma in Model.MovieActors)
                            {
                                var actorName = $"{ma?.Actor?.FirstName} {ma?.Actor?.LastName}".Trim();
                                <a class="chip" href="#" title="@actorName">@(!string.IsNullOrWhiteSpace(actorName) ? actorName : "Unknown")</a>
                            }
                        }
                        else
                        {
                            <small class="text-muted">Cast info not available.</small>
                        }
                    </div>
                </div>

                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#bookingModal"><i class="bi bi-ticket-fill me-1"></i> Book Now</button>

                    <button id="wishBtn" class="btn btn-outline-secondary" type="button" title="Add to wishlist" aria-pressed="false">
                        <i class="bi bi-heart"></i> Wishlist
                    </button>

                    <div class="ms-auto d-flex gap-1">
                        <a target="_blank" rel="noopener" class="btn btn-outline-light share-btn" href="https://twitter.com/intent/tweet?url=@UrlEncoder.Default.Encode(absoluteUrl)&text=@UrlEncoder.Default.Encode(Model?.Title ?? "Movie")" title="Share on Twitter"><i class="bi bi-twitter"></i></a>
                        <a target="_blank" rel="noopener" class="btn btn-outline-light share-btn" href="https://www.facebook.com/sharer/sharer.php?u=@UrlEncoder.Default.Encode(absoluteUrl)" title="Share on Facebook"><i class="bi bi-facebook"></i></a>
                        <a target="_blank" rel="noopener" class="btn btn-outline-light share-btn" href="https://wa.me/?text=@UrlEncoder.Default.Encode((Model?.Title ?? "") + " " + absoluteUrl)" title="Share on WhatsApp"><i class="bi bi-whatsapp"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox modal for images -->
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0">
                <button type="button" class="btn-close btn-close-white position-absolute m-3" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="d-flex justify-content-center align-items-center h-100">
                    <img id="lightboxImg" src="" alt="Full image" class="img-fluid rounded shadow-lg" />
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trailer modal -->
@if (!string.IsNullOrWhiteSpace(Model?.TrailerUrl))
{
    <div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="trailerLabel">@Model.Title — Trailer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="ratio ratio-16x9">
                        <iframe id="trailerIframe" src="" title="Trailer" allowfullscreen sandbox="allow-same-origin allow-scripts allow-presentation"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Booking modal (unchanged) -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="Create" asp-controller="Bookings" method="post" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingLabel">Book: @Model?.Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="MovieId" value="@Model?.Id" />

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input name="CustomerName" class="form-control" required />
                        <div class="invalid-feedback">Please provide your name.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input name="Email" type="email" class="form-control" required />
                        <div class="invalid-feedback">Enter a valid email.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Seats</label>
                        <input name="Seats" type="number" class="form-control" min="1" value="1" required />
                        <div class="invalid-feedback">Please select seats.</div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Confirm Booking</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/js/movie-details.js"></script>
