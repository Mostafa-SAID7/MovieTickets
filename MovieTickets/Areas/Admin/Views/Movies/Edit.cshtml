@model MovieTickets.Areas.Admin.ViewModels.MovieFormViewModel
@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Edit Movie";
}

<h3>Edit Movie</h3>

@if (TempData["ModelStateErrors"] != null)
{
    <pre class="bg-light p-2">@TempData["ModelStateErrors"]</pre>
}
@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var kv in ViewData.ModelState.Where(m => m.Value.Errors.Any()))
            {
                foreach (var err in kv.Value.Errors)
                {
                    <li>@(string.IsNullOrEmpty(err.ErrorMessage) ? err.Exception?.Message : err.ErrorMessage)</li>
                }
            }
        </ul>
    </div>
}

<form asp-action="Edit" enctype="multipart/form-data" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />

    @* RowVersion: send Base64 string so we can decode server-side *@
    @if (Model.RowVersion != null && Model.RowVersion.Length > 0)
    {
        <input type="hidden" name="RowVersionBase64" value="@Convert.ToBase64String(Model.RowVersion)" />
    }

    <div class="form-group">
        <label asp-for="Title"></label>
        <input asp-for="Title" class="form-control" />
        <span asp-validation-for="Title" class="text-danger" />
    </div>

    <div class="form-group">
        <label asp-for="Description"></label>
        <textarea asp-for="Description" class="form-control" rows="3"></textarea>
        <span asp-validation-for="Description" class="text-danger" />
    </div>

    <div class="form-row">
        <div class="form-group col-md-4">
            <label asp-for="Price"></label>
            <input asp-for="Price" class="form-control" />
            <span asp-validation-for="Price" class="text-danger"></span>
        </div>
        <div class="form-group col-md-4">
            <label asp-for="StartDate"></label>
            <input asp-for="StartDate" class="form-control" type="date" />
        </div>
        <div class="form-group col-md-4">
            <label asp-for="EndDate"></label>
            <input asp-for="EndDate" class="form-control" type="date" />
        </div>
    </div>

    <div class="form-group">
        <label>Poster</label>
        <input asp-for="PosterFile" type="file" class="form-control-file" />
        @if (!string.IsNullOrEmpty(Model.ExistingPosterUrl))
        {
            <div class="mt-2">
                <img id="posterExisting" src="@Model.ExistingPosterUrl" style="max-height:150px;" />
            </div>
        }
    </div>

    <div class="form-group">
        <label>Additional Images (multi)</label>
        <input asp-for="UploadedImages" type="file" multiple class="form-control-file" />
        <div id="imagesPreview" class="mt-2"></div>

        @if (Model.ExistingImages?.Any() == true)
        {
            <div class="mt-3">
                <h6>Existing Images</h6>
                @foreach (var img in Model.ExistingImages)
                {
                    <div class="d-inline-block text-center mr-2 mb-2">
                        <img src="@img.ImgUrl" style="max-height:100px; display:block;" />
                        <label class="mt-1">
                            <input type="checkbox" name="ImageIdsToDelete" value="@img.Id" /> Delete
                        </label>
                    </div>
                }
            </div>
        }
    </div>

    <div class="form-group">
        <label>Actors</label>
        <select asp-for="SelectedActorIds" asp-items="Model.Actors" multiple class="form-control"></select>
    </div>

    <div class="form-row">
        <div class="form-group col-md-6">
            <label asp-for="CinemaId"></label>
            <select asp-for="CinemaId" asp-items="Model.Cinemas" class="form-control"></select>
        </div>
        <div class="form-group col-md-6">
            <label asp-for="CategoryId"></label>
            <select asp-for="CategoryId" asp-items="Model.Categories" class="form-control"></select>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Save</button>
    <a asp-action="Index" class="btn btn-secondary">Back</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // preview newly selected additional images (client-side)
        var uploadedInput = document.querySelector('input[name="UploadedImages"]');
        if (uploadedInput) {
            uploadedInput.addEventListener('change', function () {
                var container = document.getElementById('imagesPreview'); container.innerHTML = '';
                Array.from(this.files).forEach(function (f) {
                    var reader = new FileReader();
                    reader.onload = function (ev) {
                        var i = document.createElement('img');
                        i.src = ev.target.result; i.style.maxHeight = '100px'; i.classList.add('mr-2','mb-2');
                        container.appendChild(i);
                    };
                    reader.readAsDataURL(f);
                });
            });
        }
    </script>
}
